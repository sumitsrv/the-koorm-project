<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCPD Assistant - Your Compassionate Productivity Companion</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        #loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2.5rem;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        p {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 10px 0;
        }

        #ComposeTarget {
            width: 100%;
            height: 100vh;
            display: none;
            background: transparent;
        }

        .feature-list {
            text-align: left;
            margin: 20px 0;
            max-width: 600px;
        }

        .feature-list li {
            margin: 10px 0;
            padding: 5px 0;
        }

        #error-message {
            display: none;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <h1>üß† OCPD Assistant</h1>
        <p>Your Compassionate Productivity Companion</p>
        <p>Loading your personalized productivity environment...</p>

        <div class="feature-list">
            <ul>
                <li>‚ú® Smart task breakdown with gentle guidance</li>
                <li>üéØ Time-boxed scheduling that respects your perfectionism</li>
                <li>üíù "Good enough" mode to overcome paralysis</li>
                <li>üß† Behavioral insights with CBT-style reframing</li>
                <li>üöÄ Anti-procrastination techniques tailored for OCPD</li>
            </ul>
        </div>
    </div>

    <div id="error-message" style="display:none">
        <h3 id="error-title">WebGL Not Supported</h3>
        <p id="error-body">Your browser doesn't support WebGL, which is required for this application. Please try using a modern browser like Chrome, Firefox, or Safari.</p>
        <pre id="error-details" style="white-space:pre-wrap; font-size:12px; background:rgba(0,0,0,0.25); padding:10px; border-radius:6px; max-width:80vw; overflow:auto; display:none"></pre>
        <button id="retry-btn" style="margin-top:10px; padding:8px 14px; border:0; border-radius:4px; background:#667eea; color:#fff; cursor:pointer;">Retry Load</button>
    </div>

    <canvas id="ComposeTarget"></canvas>

    <script>
        // Enhanced WebGL / runtime diagnostics & loader
        function detectGL() {
            const canvas = document.createElement('canvas');
            const kinds = ['webgl2','webgl','experimental-webgl'];
            const result = { supported: false, kind: null, details: {} };
            for (const k of kinds) {
                let ctx = null;
                try { ctx = canvas.getContext(k); } catch(e) { /* ignore */ }
                result.details[k] = !!ctx;
                if (!result.supported && ctx) { result.supported = true; result.kind = k; }
            }
            return result;
        }

        function showError(title, body, details) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ComposeTarget').style.display = 'none';
            const et = document.getElementById('error-title');
            const eb = document.getElementById('error-body');
            et.textContent = title;
            eb.textContent = body;
            const detEl = document.getElementById('error-details');
            if (details) {
                detEl.style.display = 'block';
                detEl.textContent = details.substring(0, 8000);
            } else {
                detEl.style.display = 'none';
            }
            document.getElementById('error-message').style.display = 'block';
        }

        const glInfo = detectGL();
        console.log('[OCPD] WebGL detection:', glInfo);

        // Always attempt load; only pre-block if clearly unsupported
        if (!glInfo.supported) {
            showError(
                'WebGL Context Unavailable',
                'No WebGL context could be created (tried WebGL2/WebGL/experimental). Ensure hardware acceleration is enabled and GPU drivers are current. You can still press Retry after fixing settings.',
                JSON.stringify(glInfo, null, 2)
            );
        }

        let scriptLoaded = false;
        let mainInvoked = false;
        let loadError = null;

        function loadApp() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            const existing = document.getElementById('bundle-script');
            if (existing) existing.remove();
            const script = document.createElement('script');
            script.id = 'bundle-script';
            script.src = 'TheKoormProject.js';
            script.defer = true;
            script.onload = () => {
                scriptLoaded = true;
                console.log('[OCPD] Bundle loaded');
                // Heuristic: wait a tick for Kotlin/Compose to call main
                setTimeout(() => {
                    if (!mainInvoked) {
                        // If main not invoked yet but GL supported, present a different error
                        showError('Application Initialization Timeout', 'The JavaScript bundle loaded but the application did not start. Check console for runtime errors.', null);
                    }
                }, 4000);
            };
            script.onerror = (e) => {
                loadError = e;
                showError('Bundle Load Failed', 'Failed to load application bundle (TheKoormProject.js). Verify server path or build output.', e && e.message ? e.message : String(e));
            };
            document.head.appendChild(script);
        }

        // Expose hook for Kotlin main to call when ready
        window.__OCPD_APP_STARTED__ = function() {
            mainInvoked = true;
            console.log('[OCPD] App signaled start');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('ComposeTarget').style.display = 'block';
        };

        document.getElementById('retry-btn').addEventListener('click', () => {
            loadApp();
        });

        window.addEventListener('error', function(e) {
            console.error('[OCPD] window error:', e.error || e.message || e);
            if (!mainInvoked) {
                showError('Runtime Error Before Start', 'An error occurred before the app could start.', (e.error && (e.error.stack || e.error.message)) || (e.message) || String(e));
            }
        });

        // Begin load (even if GL missing; user can adjust settings and retry)
        loadApp();
    </script>
</body>
</html>
